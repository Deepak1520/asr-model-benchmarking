<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-Time ASR Benchmark</title>
    <style>
        :root {
            --primary: #3498db;
            --success: #2ecc71;
            --bg: #f8f9fa;
            --text: #2c3e50;
        }

        body {
            font-family: 'Inter', sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: var(--bg);
            color: var(--text);
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
        }

        #prompt-box {
            font-size: 1.2rem;
            font-weight: 500;
            color: #555;
            line-height: 1.5;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            border: 2px dashed #ddd;
            border-radius: 8px;
            background: #fafafa;
            padding: 20px;
        }

        .controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin: 20px 0;
        }

        button {
            padding: 12px 24px;
            font-size: 1rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 600;
        }

        #btn-record {
            background: var(--primary);
            color: white;
        }

        #btn-record.recording {
            background: #e74c3c;
            animation: pulse 1.5s infinite;
        }

        #btn-next {
            background: #95a5a6;
            color: white;
        }

        @keyframes pulse {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.7;
            }

            100% {
                opacity: 1;
            }
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 20px;
        }

        .metric-card {
            background: #f1f3f5;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .metric-val {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
            display: block;
            margin-top: 5px;
        }

        .metric-label {
            font-size: 0.85rem;
            color: #7f8c8d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        #transcription-result {
            margin-top: 20px;
            padding: 15px;
            border-left: 4px solid var(--success);
            background: #f0fff4;
            display: none;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 30px;
        }

        th,
        td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
        }

        tr:hover {
            background: #f8f9fa;
        }
    </style>
</head>

<body>

    <h1>üéôÔ∏è Real-Time ASR Benchmark</h1>

    <div class="card">
        <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
            <label style="font-weight:bold; color:#7f8c8d;">INPUT MODE:</label>
            <div>
                <input type="radio" id="mode-mic" name="mode" value="mic" checked onchange="toggleMode()"> <label
                    for="mode-mic">Microphone</label>
                <input type="radio" id="mode-upload" name="mode" value="upload" onchange="toggleMode()"> <label
                    for="mode-upload">File Upload</label>
            </div>
        </div>

        <div id="mic-controls">
            <label style="display:block; margin-bottom: 10px; font-weight:bold; color:#7f8c8d;">READ THIS ALOUD:</label>
            <div id="prompt-box">Loading prompt...</div>
        </div>

        <div id="upload-controls"
            style="display:none; text-align:center; padding: 20px; border: 2px dashed #ddd; border-radius: 8px;">
            <p>Upload a WAV file (e.g. from <code>dataset/noisy/</code>)</p>
            <input type="file" id="file-input" accept=".wav,.mp3">
            <br><br>
            <label style="display:block; text-align:left; font-weight:bold; margin-bottom:5px;">Reference Text (Paste
                here):</label>
            <textarea id="ref-text-input"
                style="width:100%; height:60px; padding:10px; border-radius:6px; border:1px solid #ddd;"
                placeholder="Paste the ground truth text here..."></textarea>
        </div>

        <div class="controls" style="margin-top:20px; flex-wrap: wrap;">
            <select id="model-select"
                style="padding: 12px; border-radius: 6px; border: 1px solid #ddd; background: white; font-size: 1rem;">
                <option value="Faster-Whisper">Faster-Whisper (Default)</option>
                <option value="WhisperX">WhisperX (High Accuracy)</option>
                <option value="whisper.cpp">whisper.cpp (Real-time Optimized)</option>
            </select>

            <div
                style="display:flex; align-items:center; gap:5px; background:#fff3cd; padding:0 10px; border-radius:6px; border:1px solid #ffeeba;">
                <input type="checkbox" id="noise-check">
                <label for="noise-check" style="font-size:0.9rem; font-weight:600; color:#856404;">Inject Noise</label>
            </div>

            <button id="btn-record">Start Recording</button> <!-- Will change text based on mode -->
            <button id="btn-next">Shuffle Prompt</button>
        </div>

        <div id="status"
            style="text-align:center; color:#7f8c8d; min-height: 24px; font-size: 0.9rem; margin-top:10px;">Ready</div>
    </div>

    <div class="card" id="results-area" style="opacity: 0.5; pointer-events: none;">
        <h3>Evaluation Metrics</h3>
        <div class="results-grid">
            <div class="metric-card">
                <span class="metric-label">Latency</span>
                <span class="metric-val" id="val-latency">-</span>
            </div>
            <div class="metric-card">
                <span class="metric-label">RTF</span>
                <span class="metric-val" id="val-rtf">-</span>
            </div>
            <div class="metric-card">
                <span class="metric-label">WER</span>
                <span class="metric-val" id="val-wer">-</span>
            </div>
            <div class="metric-card">
                <span class="metric-label">CER</span>
                <span class="metric-val" id="val-cer">-</span>
            </div>
            <div class="metric-card">
                <span class="metric-label">Load Time</span>
                <span class="metric-val" id="val-load">-</span>
            </div>
            <div class="metric-card">
                <span class="metric-label">Peak RAM</span>
                <span class="metric-val" id="val-mem">-</span>
            </div>
        </div>

        <div id="transcription-result">
            <strong>Model Heard:</strong> <span id="text-heard">...</span>
        </div>
    </div>

    <div class="card">
        <h3>Session History</h3>
        <table>
            <thead>
                <tr>
                    <th>Time</th>
                    <th>Latency</th>
                    <th>RTF</th>
                    <th>WER</th>
                    <th>Load Time</th>
                    <th>Peak RAM</th>
                    <th>Transcription</th>
                </tr>
            </thead>
            <tbody id="history-table">
            </tbody>
        </table>
    </div>

    <script>
        const PROMPTS = [
            "The rapid advancement of artificial intelligence has transformed industries, allowing for automation and efficiency.",
            "Climate change represents one of the most significant challenges of our time, requiring global cooperation.",
            "Exploring the vastness of space has always been a dream for humanity, driving us to develop new technologies.",
            "Sustainable energy sources such as solar and wind power are becoming increasingly important for our future.",
            "The internet has revolutionized communication, connecting people from all corners of the globe instantly.",
            "Art and music have the power to evoke deep emotions and transcend cultural barriers around the world.",
            "Reading books is a timeless activity that expands our knowledge and improves our vocabulary significantly.",
            "Healthy eating habits combined with regular physical exercise are essential for maintaining a strong immune system."
        ];

        let mediaRecorder;
        let audioChunks = [];
        let isRecording = false;
        let currentPrompt = "";

        const promptBox = document.getElementById('prompt-box');
        const recordBtn = document.getElementById('btn-record');
        const statusEl = document.getElementById('status');
        const resultsArea = document.getElementById('results-area');

        function setRandomPrompt() {
            currentPrompt = PROMPTS[Math.floor(Math.random() * PROMPTS.length)];
            promptBox.innerText = currentPrompt;
        }

        let mode = "mic"; // mic or upload

        function toggleMode() {
            if (document.getElementById('mode-mic').checked) {
                mode = "mic";
                document.getElementById('mic-controls').style.display = "block";
                document.getElementById('upload-controls').style.display = "none";
                document.getElementById('btn-next').style.display = "inline-block";
                recordBtn.innerText = "Start Recording";
                recordBtn.onclick = handleMicClick;
            } else {
                mode = "upload";
                document.getElementById('mic-controls').style.display = "none";
                document.getElementById('upload-controls').style.display = "block";
                document.getElementById('btn-next').style.display = "none";
                recordBtn.innerText = "Upload & Evaluate";
                recordBtn.onclick = handleUploadClick;
            }
        }

        const handleMicClick = async () => {
            if (!isRecording) {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);

                    mediaRecorder.ondataavailable = event => {
                        audioChunks.push(event.data);
                    };

                    mediaRecorder.onstop = async () => {
                        statusEl.innerText = "Processing...";
                        const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                        await sendAudio(audioBlob, currentPrompt);
                    };

                    audioChunks = [];
                    mediaRecorder.start();
                    isRecording = true;
                    recordBtn.innerText = "Stop & Evaluate";
                    recordBtn.classList.add("recording");
                    statusEl.innerText = "Recording... Read the prompt!";

                } catch (err) {
                    console.error("Mic Error:", err);
                    alert("Could not access microphone.");
                }
            } else {
                mediaRecorder.stop();
                isRecording = false;
                recordBtn.innerText = "Start Recording";
                recordBtn.classList.remove("recording");
            }
        };

        const handleUploadClick = async () => {
            const fileInput = document.getElementById('file-input');
            const refInput = document.getElementById('ref-text-input');

            if (fileInput.files.length === 0) {
                alert("Please select a file.");
                return;
            }
            if (!refInput.value.trim()) {
                alert("Please paste the reference text.");
                return;
            }

            statusEl.innerText = "Uploading & Processing...";
            await sendAudio(fileInput.files[0], refInput.value.trim());
        };

        // Initial Bind
        recordBtn.onclick = handleMicClick;
        document.getElementById('btn-next').onclick = setRandomPrompt;

        async function sendAudio(blob, referenceText) {
            const formData = new FormData();
            const modelName = document.getElementById('model-select').value;
            const injectNoise = document.getElementById('noise-check').checked;

            formData.append("audio", blob, "audio.wav");
            formData.append("reference", referenceText);
            formData.append("model_name", modelName);
            formData.append("inject_noise", injectNoise);

            let msg = `Processing with ${modelName}...`;
            if (injectNoise) msg += " (Adding Noise...)";
            statusEl.innerText = msg;

            try {
                const response = await fetch("/transcribe", { method: "POST", body: formData });
                const result = await response.json();

                if (result.error) {
                    alert("Error: " + result.error);
                    statusEl.innerText = "Error: " + result.error;
                    return;
                }

                displayResults(result);

            } catch (err) {
                console.error(err);
                statusEl.innerText = "Error during processing.";
            }
        }

        function displayResults(data) {
            statusEl.innerText = "Done!";
            resultsArea.style.opacity = "1";
            document.getElementById('transcription-result').style.display = "block";

            document.getElementById('val-latency').innerText = data.metrics.latency.toFixed(2) + "s";
            document.getElementById('val-rtf').innerText = data.metrics.rtf.toFixed(2);
            document.getElementById('val-wer').innerText = (data.metrics.wer * 100).toFixed(1) + "%";
            document.getElementById('val-cer').innerText = (data.metrics.cer * 100).toFixed(1) + "%";
            document.getElementById('val-load').innerText = data.metrics.load_time.toFixed(2) + "s";
            document.getElementById('val-mem').innerText = Math.round(data.metrics.peak_memory) + " MB";
            document.getElementById('text-heard').innerText = data.transcription;

            const table = document.getElementById('history-table');
            const row = table.insertRow(0);
            const timeStr = new Date().toLocaleTimeString();
            row.innerHTML = `
            <td>${timeStr}</td>
            <td>${data.metrics.latency.toFixed(2)}s</td>
            <td>${data.metrics.rtf.toFixed(2)}</td>
            <td>${(data.metrics.wer * 100).toFixed(1)}%</td>
            <td>${data.metrics.load_time.toFixed(2)}s</td>
            <td>${Math.round(data.metrics.peak_memory)} MB</td>
            <td style="font-size:0.9rem; color:#666;">${data.transcription}</td>
        `;
        }

        setRandomPrompt();
    </script>
</body>

</html>